<!DOCTYPE html>
<html>
<head>
  <title>Predict Path Risk</title>
</head>
<body>
  <h2>Path Risk Predictor</h2>

  <label for="source">Source Node:</label>
  <input id="source" type="text"><br>

  <label for="target">Target Node:</label>
  <input id="target" type="text"><br>

  <label for="strategy">Select Strategy:</label>
  <select id="strategy" onchange="onStrategyChange()">
    <option value="best">Best Path (Latency + Health)</option>
    <option value="risk">Lowest Risk Path</option>
    <option value="latency">Lowest Latency Path</option>
    <option value="hops">Shortest Path (Fewest Hops)</option>
  </select><br><br>

  <button onclick="predictPath(true)">Predict</button>
  <button onclick="resetInputs()">Reset</button><br><br>

  <label>
    <input type="checkbox" id="autoRefreshToggle">
    Auto-refresh every 5 seconds
  </label>

  <h3>Results:</h3>
  <div id="results"></div>
  <p id="lastUpdated" style="font-style: italic; color: gray;"></p>

  <script>
    let predictionStarted = false;

    function updateTimestamp() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      document.getElementById("lastUpdated").textContent = `Last updated: ${timeStr}`;
    }

    function resetInputs() {
      document.getElementById("source").value = "";
      document.getElementById("target").value = "";
      document.getElementById("strategy").value = "best";
      document.getElementById("autoRefreshToggle").checked = false;
      document.getElementById("results").innerHTML = "";
      document.getElementById("lastUpdated").textContent = "";
      predictionStarted = false;
    }

    function onStrategyChange() {
      if (predictionStarted) {
        predictPath(false);
      }
    }

    async function predictPath(isManual = false) {
      const source = document.getElementById("source").value;
      const target = document.getElementById("target").value;
      const strategy = document.getElementById("strategy").value;

      if (!source || !target) {
        document.getElementById("results").innerHTML = "<p>Please enter both source and target nodes.</p>";
        document.getElementById("lastUpdated").textContent = "";
        return;
      }

      if (isManual) {
        predictionStarted = true;
      }

      const response = await fetch("/predict-path", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ source, target, strategy })
      });

      const data = await response.json();
      const results = document.getElementById("results");
      results.innerHTML = "";

      if (data.paths.length === 0) {
        results.innerHTML = "<p>No valid paths found.</p>";
      } else {
        results.innerHTML += `<p><em>${data.message}</em></p>`;
        data.paths.forEach(p => {
          const pathStr = p.path.join(" â†’ ");
          results.innerHTML += `
            <div style="margin-bottom: 12px;">
              <strong>Path:</strong> ${pathStr}<br>
              <strong>Latency:</strong> ${p.latency} ms<br>
              ${p.health_penalty !== undefined ? `<strong>Health Penalty:</strong> ${p.health_penalty}<br>` : ""}
              ${p.risk_score !== undefined ? `<strong>Risk Score:</strong> ${p.risk_score}<br>` : ""}
            </div><hr>`;
        });
      }

      updateTimestamp();
    }

    setInterval(() => {
      const autoRefresh = document.getElementById("autoRefreshToggle").checked;
      if (predictionStarted && autoRefresh) {
        predictPath(false);
      }
    }, 5000);
  </script>
</body>
</html>
